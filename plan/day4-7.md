# ğŸ“… æ ¸å¿ƒæ•°æ®ç»“æ„æ”»åšè®¡åˆ’ (Day 4 - 7): è·³è¡¨ (SkipList)

**é˜¶æ®µç›®æ ‡**ï¼šä»é›¶æ‰‹å†™ä¸€ä¸ªå·¥ä¸šçº§çš„ C++ è·³è¡¨å¼•æ“ï¼Œç†è§£å…¶åº•å±‚åŸç†ä¸å†…å­˜ç®¡ç†ã€‚

## ğŸ“… Day 4: ç†è®ºåœ°åŸºä¸é¡¹ç›®éª¨æ¶ (Theory & Setup)

**ä»Šæ—¥ä»»åŠ¡**ï¼šç†è§£è·³è¡¨ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Œå¹¶æŠŠ C++ ç±»çš„"å¤´"èµ·å¥½ã€‚

### 1. ç†è®ºå­¦ä¹  (ä¸Šåˆ)

**æ ¸å¿ƒé—®é¢˜**ï¼šé“¾è¡¨æŸ¥æ‰¾æ˜¯ O(N)ï¼Œæ€ä¹ˆä¼˜åŒ–åˆ° O(logN)ï¼Ÿ

**å…³é”®æ¦‚å¿µ**ï¼š

- **å¤šçº§ç´¢å¼•**ï¼šåƒåç”µæ¢¯ä¸€æ ·ï¼Œä¸€å±‚å±‚å¾€ä¸Šç›–ã€‚
- **æ™‹å‡æ¦‚ç‡ (p)**ï¼šé€šå¸¸å– 1/4 (25%)ï¼Œå³æ¯ 4 ä¸ªèŠ‚ç‚¹æœ‰ 1 ä¸ªä¼šæ™‹å‡åˆ°ä¸Šä¸€å±‚ã€‚
- **ç©ºé—´æ¢æ—¶é—´**ï¼šå¤šå‡ºæ¥çš„æŒ‡é’ˆæ•°ç»„å°±æ˜¯æ¢å–é€Ÿåº¦çš„ä»£ä»·ã€‚

### 2. æ­å»ºéª¨æ¶ (ä¸‹åˆ)

è¯·åœ¨ `KVStore/include/` ä¸‹æ–°å»º `skiplist.h`ï¼ŒæŠŠè¿™ä¸ªéª¨æ¶æ•²è¿›å»ã€‚

```cpp
#pragma once
#include <iostream>
#include <vector>
#include <cstdlib>
#include <cmath>
#include <cstring>
#include <mutex>

// èŠ‚ç‚¹ç±»æ¨¡æ¿
template<typename K, typename V>
class Node {
public:
    Node() {}
    Node(K k, V v, int level);
    ~Node();

    K get_key() const;
    V get_value() const;
    void set_value(V);

    // çº¿æ€§æ•°ç»„ï¼Œforward[i] æŒ‡å‘ç¬¬ i å±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    Node<K, V> **forward;
    int node_level;
    
private:
    K key;
    V value;
};

// è·³è¡¨ç±»æ¨¡æ¿
template <typename K, typename V>
class SkipList {
public:
    SkipList(int max_level);
    ~SkipList();

    // æ ¸å¿ƒåŠŸèƒ½æ¥å£
    int get_random_level();
    Node<K, V>* create_node(K k, V v, int level);
    int insert_element(K, V);
    void display_list();
    bool search_element(K, V);
    void delete_element(K);

private:
    int _max_level;       // æœ€å¤§å±‚æ•°é™åˆ¶
    int _skip_list_level; // å½“å‰è·³è¡¨å®é™…å±‚æ•°
    Node<K, V> *_header;  // å¤´èŠ‚ç‚¹æŒ‡é’ˆ
    int _element_count;   // å…ƒç´ è®¡æ•°
    std::mutex _mtx;      // åé¢åšå¹¶å‘ç”¨çš„é”
};
```

## ğŸ“… Day 5: è®©æ•°æ®æµåŠ¨ â€”â€” æ’å…¥ä¸æŸ¥è¯¢ (Insert & Search)

**ä»Šæ—¥ä»»åŠ¡**ï¼šå®ç°è·³è¡¨çš„"å¿ƒè„"ï¼Œè®©æ•°æ®èƒ½å­˜è¿›å»ï¼Œä¹Ÿèƒ½æŸ¥å‡ºæ¥ã€‚

### 1. è¾…åŠ©å‡½æ•°å®ç°

åœ¨ `src/skiplist.cpp` (æˆ–å¤´æ–‡ä»¶) ä¸­å®ç°ï¼š

#### get_random_level()ï¼š

```cpp
é€»è¾‘ï¼šint level = 1; while (rand() % 2) level++;
æ³¨æ„ï¼šè¿”å›å€¼ä¸èƒ½è¶…è¿‡ _max_levelã€‚
```

#### create_node(k, v, level)ï¼š

```cpp
é€»è¾‘ï¼šn = new Node(k, v, level);
æ³¨æ„ï¼šn->forward = new Node*[level + 1]; (è®°å¾—ç»™æ•°ç»„åˆ†é…å†…å­˜)ã€‚
```

### 2. æ’å…¥é€»è¾‘ (Insert) â€”â€” æ ¸å¿ƒè€ƒç‚¹

**æ­¥éª¤æŒ‡å¼•**ï¼š

1. **ä¾¦å¯Ÿå…µ (current)**ï¼šä» _header çš„æœ€é«˜å±‚å¼€å§‹ï¼Œå‘å³æ‰«æã€‚
2. **è®°å½•è·¯å¾„ (update[])**ï¼šå¦‚æœ current->next çš„ key å°äºç›®æ ‡ keyï¼Œå°±å‘å³èµ°ï¼›å¦åˆ™ï¼Œè®°å½•å½“å‰ä½ç½®åˆ° update æ•°ç»„ï¼Œç„¶åä¸‹æ²‰ä¸€å±‚ã€‚
3. **åˆ°åº•äº†**ï¼šå½“å±‚æ•° < 0 æ—¶ï¼Œä½ å°±åœ¨ç¬¬ 0 å±‚æ‰¾åˆ°äº†æ’å…¥ä½ç½®ã€‚
4. **å»ºç«‹è¿æ¥**ï¼šç”Ÿæˆæ–°èŠ‚ç‚¹ï¼Œéå†æ¯ä¸€å±‚ï¼ŒæŠŠæ–°èŠ‚ç‚¹"ç¼"è¿›é“¾è¡¨é‡Œï¼š

```cpp
node->forward[i] = update[i]->forward[i];
update[i]->forward[i] = node;
```

### 3. æŸ¥è¯¢é€»è¾‘ (Search)

é€»è¾‘å’Œæ’å…¥çš„å‰åŠéƒ¨åˆ†ä¸€æ¨¡ä¸€æ ·ï¼

åŒºåˆ«åœ¨äºï¼šåˆ°åº•åï¼Œåˆ¤æ–­ `current->forward[0]->key` æ˜¯å¦ç­‰äºç›®æ ‡ keyã€‚

## ğŸ“… Day 6: å†…å­˜ç®¡ç†ä¸åˆ é™¤ (Memory & Delete)

**ä»Šæ—¥ä»»åŠ¡**ï¼šå­¦ä¼šä¼˜é›…åœ°æ¸…ç†æˆ˜åœºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚

### 1. åˆ é™¤é€»è¾‘ (Delete)

**æ­¥éª¤æŒ‡å¼•**ï¼š

1. åŒæ ·å…ˆç”¨ `update[]` æ•°ç»„æ‰¾åˆ°æ¯ä¸€å±‚çš„å‰é©±èŠ‚ç‚¹ã€‚
2. æ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨ã€‚
3. **æ–­å¼€è¿æ¥**ï¼šä»æœ€ä½å±‚å‘ä¸Šéå†ï¼Œå¦‚æœ `update[i]->forward[i]` æ˜¯ç›®æ ‡èŠ‚ç‚¹ï¼Œå°±ç»•è¿‡å®ƒï¼š

```cpp
update[i]->forward[i] = target->forward[i];
```

4. **æ”¶ç¼©é«˜åº¦**ï¼šå¦‚æœåˆ é™¤åï¼Œæœ€é«˜å±‚åªå‰©å¤´èŠ‚ç‚¹äº†ï¼Œè®°å¾— `_skip_list_level--`ã€‚
5. **é‡Šæ”¾å†…å­˜**ï¼š`delete target_node;`

### 2. ææ„å‡½æ•° (Destructor)

**ä»»åŠ¡**ï¼šåœ¨ `~SkipList()` é‡Œï¼Œéå†ç¬¬ 0 å±‚çš„å®Œæ•´é“¾è¡¨ã€‚

**æ“ä½œ**ï¼šä¸€ä¸ªä¸€ä¸ª `delete` èŠ‚ç‚¹ï¼ŒæŠŠ `create_node` ç”³è¯·çš„å†…å­˜å…¨è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚

## ğŸ“… Day 7: æ³›å‹æ”¹é€ ä¸å‹åŠ›æµ‹è¯• (Templates & Benchmark)

**ä»Šæ—¥ä»»åŠ¡**ï¼šæŠŠ"ç©å…·ä»£ç "å‡çº§ä¸º"é€šç”¨ç»„ä»¶"ï¼Œå¹¶æµ‹è¯•å®ƒçš„æé™ã€‚

### 1. æ³›å‹ (Templates) è°ƒè¯•

å¦‚æœä½ ä¹‹å‰æŠŠ key å†™æ­»äº† `int`ï¼Œä»Šå¤©è¦æŠŠæ‰€æœ‰ç›¸å…³ä»£ç æ”¹æˆ `K`ã€‚

**å‘ç‚¹é¢„è­¦**ï¼šæ¨¡æ¿ç±»çš„å®ç°å¦‚æœæ”¾åœ¨ `.cpp` é‡Œï¼Œç¼–è¯‘æ—¶å¯èƒ½ä¼šæŠ¥ `undefined reference`ã€‚

**è§£æ³•**ï¼šå»ºè®®æŠŠæ‰€æœ‰å®ç°ç›´æ¥å†™åœ¨ `.h` é‡Œï¼Œæˆ–è€…æ”¹åä¸º `.tpp` å¹¶åœ¨å¤´æ–‡ä»¶æœ«å°¾ `include`ã€‚

### 2. ç¼–å†™æµ‹è¯•ç¨‹åº (main.cpp)

```cpp
#include "skiplist.h"
#include <chrono>

int main() {
    SkipList<int, std::string> skipList(18);
    
    auto start = std::chrono::high_resolution_clock::now();
    // ç–¯ç‹‚æ’å…¥ 100,000 æ•°æ®
    for (int i = 0; i < 100000; i++) {
        skipList.insert_element(i, "a");
    }
    auto finish = std::chrono::high_resolution_clock::now();
    
    std::cout << "è€—æ—¶: " << std::chrono::duration_cast<std::chrono::milliseconds>(finish - start).count() << "ms\n";
    return 0;
}
```

### 3. éªŒæ”¶æ ‡å‡†

- [ ] ç¼–è¯‘æ— è­¦å‘Šã€‚
- [ ] æ’å…¥ 10 ä¸‡æ¡æ•°æ®ä¸å´©æºƒã€‚
- [ ] èƒ½å¤Ÿæ­£ç¡®æŸ¥è¯¢åˆ°åˆšæ’å…¥çš„æ•°æ®ã€‚
- [ ] ä½¿ç”¨ valgrind è¿è¡Œæ— å†…å­˜æ³„æ¼ã€‚