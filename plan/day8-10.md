# âš”ï¸ ç¬¬ä¸‰é˜¶æ®µæˆ˜æœ¯æ‰‹å†Œï¼šæŒä¹…åŒ–å­˜å‚¨ (Day 8 - 10)

**æ ¸å¿ƒä»»åŠ¡**ï¼šå®ç°æ•°æ®çš„è½ç›˜ä¸æ¢å¤ï¼Œè®©æ•°æ®åœ¨ç¨‹åºé‡å¯åä¸ä¸¢å¤±ã€‚
**æŠ€æœ¯éš¾ç‚¹**ï¼šæ–‡ä»¶æ ¼å¼è®¾è®¡ã€æ³›å‹åºåˆ—åŒ–/ååºåˆ—åŒ–ã€æ–‡ä»¶ IO æ“ä½œã€‚

## ğŸ“… Day 8: é¡¶å±‚è®¾è®¡ â€”â€” æ³›å‹åè®®ä¸æ¥å£ (Generic Protocol)

**ä»Šæ—¥ç›®æ ‡**ï¼šè®¾è®¡ä¸€å¥—èƒ½å…¼å®¹ `int`ã€`string` åŠè‡ªå®šä¹‰ `struct` çš„äºŒè¿›åˆ¶å­˜å‚¨æ ¼å¼ã€‚

### 1. ç†è®ºçªå‡»ï¼šé€šç”¨äºŒè¿›åˆ¶åè®®

ä¸ºäº†è®©è·³è¡¨æ”¯æŒä»»æ„ç±»å‹çš„ Key/Value æŒä¹…åŒ–ï¼Œæˆ‘ä»¬ä¸èƒ½å‡è®¾æ•°æ®ä¸€å®šæœ‰ `.size()` æ–¹æ³•ï¼ˆæ¯”å¦‚ `int` å°±æ²¡æœ‰ï¼‰ã€‚
æˆ‘ä»¬éœ€è¦å¼•å…¥**åºåˆ—åŒ–å±‚**ï¼š

* **ç­–ç•¥**ï¼šä¸ç®¡ Key/Value æ˜¯ä»€ä¹ˆç±»å‹ï¼Œå…ˆç»Ÿä¸€è½¬æ¢æˆ `std::string`ï¼ˆäºŒè¿›åˆ¶æµï¼‰ï¼Œå†å†™å…¥æ–‡ä»¶ã€‚

* **æ ¼å¼**ï¼š

  ```
  [Keyé•¿åº¦ (4å­—èŠ‚)] + [Valueé•¿åº¦ (4å­—èŠ‚)] + [Key äºŒè¿›åˆ¶æ•°æ®] + [Value äºŒè¿›åˆ¶æ•°æ®]
  
  ```

### 2. åºåˆ—åŒ–è¾…åŠ©å‡½æ•° (å…³é”®æ–°å¢ ğŸ”¥)

åœ¨ `include/skiplist.h` çš„ `SkipList` ç±»å®šä¹‰**ä¹‹å‰**ï¼Œå¢åŠ ä¸€ç»„æ¨¡æ¿å‡½æ•°ï¼Œç”¨äºå¤„ç†ç±»å‹è½¬æ¢ã€‚

> **âš ï¸ æ ¸å¿ƒå®‰å…¨æœºåˆ¶**ï¼šå¼•å…¥ `<type_traits>`ï¼Œä½¿ç”¨ `static_assert` ç¦æ­¢å¯¹åŒ…å«æŒ‡é’ˆçš„å¤æ‚å¯¹è±¡ï¼ˆå¦‚ `struct` ä¸­å« `string`ï¼‰ä½¿ç”¨é»˜è®¤åºåˆ—åŒ–ï¼Œé˜²æ­¢æµ…æ‹·è´å¯¼è‡´çš„ Segfaultã€‚

```cpp
#include <type_traits> // å¿…é¡»å¼•å…¥è¿™ä¸ªå¤´æ–‡ä»¶

// é»˜è®¤ç‰ˆæœ¬ï¼šå¤„ç† int, double, char ç­‰ POD (Plain Old Data) ç±»å‹
template <typename T>
std::string to_string(const T& value) {
    // ğŸ”¥ ç¼–è¯‘æœŸæ£€æŸ¥ï¼šå¦‚æœ T ä¸æ˜¯â€œç®€å•å¯å¤åˆ¶â€çš„ï¼ˆæ¯”å¦‚åŒ…å« std::stringï¼‰ï¼Œç›´æ¥æŠ¥é”™ï¼
    static_assert(std::is_trivially_copyable<T>::value, "æ­¤ç±»å‹åŒ…å«æŒ‡é’ˆæˆ–å¤æ‚å¯¹è±¡ï¼Œå¿…é¡»æ‰‹åŠ¨å®ç° to_string ç‰¹åŒ–ï¼");
    return std::string((const char*)&value, sizeof(T));
}

// ç‰¹åŒ–ç‰ˆæœ¬ï¼šå¤„ç† std::string
template <>
std::string to_string(const std::string& value) {
    return value;
}

// -------------------------------------------

// ååºåˆ—åŒ–é»˜è®¤ç‰ˆæœ¬
template <typename T>
void from_string(const std::string& str, T& value) {
    // ğŸ”¥ åŒæ ·çš„ç¼–è¯‘æœŸå®‰å…¨æ£€æŸ¥
    static_assert(std::is_trivially_copyable<T>::value, "æ­¤ç±»å‹åŒ…å«æŒ‡é’ˆæˆ–å¤æ‚å¯¹è±¡ï¼Œå¿…é¡»æ‰‹åŠ¨å®ç° from_string ç‰¹åŒ–ï¼");
    memcpy(&value, str.c_str(), sizeof(T));
}

// ååºåˆ—åŒ–ç‰¹åŒ–ç‰ˆæœ¬
template <>
void from_string(const std::string& str, std::string& value) {
    value = str;
}
```

### 3. æ¥å£å®šä¹‰ (ä¸‹åˆ)

åœ¨ `SkipList` ç±»ä¸­å¢åŠ æŒä¹…åŒ–æ¥å£ï¼š

```
public:
    void dump_file(); 
    void load_file();

private:
    std::string _file_path = "dump_file"; 
    std::ofstream _file_writer;
    std::ifstream _file_reader;

```

## ğŸ“… Day 9: æ•°æ®è½ç›˜ â€”â€” å®ç° `dump_file` (Serialization)

**ä»Šæ—¥ç›®æ ‡**ï¼šå®ç°é€šç”¨çš„æ•°æ®å¿«ç…§ä¿å­˜åŠŸèƒ½ã€‚

### 1. å®ç°æ­¥éª¤

1. **æ‰“å¼€æ–‡ä»¶**ï¼š`_file_writer.open(_file_path)`ã€‚

2. **éå†èŠ‚ç‚¹**ï¼šä» `_header->forward[0]` å¼€å§‹éå†ç¬¬ 0 å±‚ã€‚

3. **è½¬æ¢æ•°æ® (æ ¸å¿ƒ)**ï¼š

   * è°ƒç”¨ `to_string(node->get_key())` å¾—åˆ° `key_str`ã€‚

   * è°ƒç”¨ `to_string(node->get_value())` å¾—åˆ° `val_str`ã€‚

4. **å†™å…¥é•¿åº¦**ï¼šè·å– `key_str.size()` å’Œ `val_str.size()` å¹¶å†™å…¥ï¼ˆå„å  4 å­—èŠ‚ï¼‰ã€‚

5. **å†™å…¥å†…å®¹**ï¼šå†™å…¥ `key_str.data()` å’Œ `val_str.data()`ã€‚

### 2. ä»£ç ç‰‡æ®µé¢„æ¼”

```
// 1. åºåˆ—åŒ–
std::string key_str = to_string(node->get_key());
std::string val_str = to_string(node->get_value());

// 2. è·å–é•¿åº¦
int key_len = key_str.size();
int val_len = val_str.size();

// 3. å†™å…¥ (é•¿åº¦ + å†…å®¹)
_file_writer.write((char*)&key_len, sizeof(int));
_file_writer.write(key_str.data(), key_len);

_file_writer.write((char*)&val_len, sizeof(int));
_file_writer.write(val_str.data(), val_len);

```

## ğŸ“… Day 10: æ•°æ®å¤æ´» â€”â€” å®ç° `load_file` (Deserialization)

**ä»Šæ—¥ç›®æ ‡**ï¼šç¨‹åºå¯åŠ¨æ—¶ï¼Œè§£ææ–‡ä»¶å¹¶é‡å»ºè·³è¡¨ã€‚

### 1. å®ç°æ­¥éª¤

1. **æ‰“å¼€æ–‡ä»¶**ï¼š`_file_reader.open(_file_path)`ã€‚

2. **å¾ªç¯è¯»å–**ï¼š

   * å…ˆè¯» 4 å­—èŠ‚ -> `key_len`ã€‚

   * è¯»å– `key_len` å­—èŠ‚åˆ° `key_content` ç¼“å†²åŒºã€‚

   * å†è¯» 4 å­—èŠ‚ -> `val_len`ã€‚

   * è¯»å– `val_len` å­—èŠ‚åˆ° `val_content` ç¼“å†²åŒºã€‚

3. **ååºåˆ—åŒ– (æ ¸å¿ƒ)**ï¼š

   * æ„é€ ä¸´æ—¶çš„ `K key` å’Œ `V value` å˜é‡ã€‚

   * è°ƒç”¨ `from_string(key_content, key)` è¿˜åŸ Keyã€‚

   * è°ƒç”¨ `from_string(val_content, value)` è¿˜åŸ Valueã€‚

4. **æ’å…¥**ï¼š`insert(key, value)`ã€‚

### 2. éªŒè¯æµ‹è¯• (`main.cpp`)

* **æµ‹è¯• 1 (åŸºç¡€ç±»å‹)**ï¼šå­˜ `int` key, `string` valueã€‚

* **æµ‹è¯• 2 (å…¨ POD)**ï¼šå­˜ `int` key, `double` value (éªŒè¯æ³›å‹æ˜¯å¦ç”Ÿæ•ˆ)ã€‚

* **æµç¨‹**ï¼š`insert` -> `dump_file` -> é€€å‡ºç¨‹åº -> é‡æ–°è¿è¡Œ -> `load_file` -> `search`ã€‚

## ğŸ’¡ é˜Ÿé•¿é”¦å›Šï¼šå·¥ç¨‹åŒ–ç»†èŠ‚

1. **æ–‡ä»¶æ‰“å¼€æ¨¡å¼**ï¼š

   * `dump_file` æ—¶ç”¨ `std::ios::out | std::ios::trunc`ï¼ˆè¦†ç›–å†™ï¼‰ã€‚

   * `load_file` æ—¶ç”¨ `std::ios::in`ï¼ˆåªè¯»ï¼‰ã€‚

2. **é»˜è®¤åŠ è½½**ï¼š

   * å»ºè®®åœ¨ `SkipList` çš„æ„é€ å‡½æ•°æœ€åä¸€è¡Œç›´æ¥è°ƒç”¨ `load_file()`ï¼Œå®ç°â€œæ— æ„Ÿæ¢å¤â€ã€‚

3. **ç¼“å†²åŒºç®¡ç†**ï¼š

   * è¯»å–æ—¶å¯ä»¥ä½¿ç”¨ `std::vector<char>` ä½œä¸ºä¸´æ—¶ bufferï¼Œè¿™å°±ä¸ç”¨æ‰‹åŠ¨ `new/delete` char æ•°ç»„äº†ã€‚

   * ä¾‹å¦‚ï¼š`key_content.resize(key_len); file.read(&key_content[0], key_len);`
```